El shell Bash

MacProgramadores

las líneas del script original y los breakpoints que vayamos fijando. También
desactiva la traza (poniendo _trace a 0). Hecho esto el bucle while carga
el script original en el array _lineas. Estas líneas será necesario tenerlas
cargadas en memoria por dos razones: Para poderlas imprimir junto con los
breakpoints, y poderlas mostrar cuando el modo de trace esté activado.
Obsérvese que read no recibe como argumento una posición del array, sino
que leemos de la variable $REPLY, esto está hecho así porque $REPLY
preserva los espacios que indentan las líneas del script original.
Por último fijamos dos traps, uno para que cuando acabe el script original
_finscript() libere el fichero temporal, y otro para que se ejecute
_steptrap() cada vez que avance un paso el fichero original. Como
veremos a continuación, _steptrap() para el depurador cuando _steps
valga 0, o cuando se esté sobre un breakpoint. _steps puede tomar un valor
positivo indicando el número de pasos a avanzar (p.e _step=3 indica que
avancemos 3 pasos y paremos), puede ser 0 en cuyo caso para el depurador,
o puede ser un número negativo en cuyo caso no para el depurador.

3.4. Funciones del depurador
3.4.1.

Avanzar paso a paso

Estas funciones estarán definidas en el fichero bashdb.fn. La primera de
ellas es _steptrap(), la cual, cuando se activa el trap SIGDEBUG, es
llamada por el shell, después de leer, y antes de ejecutar cada línea del script.
Su implementación se muestra en el Listado 9.4.
# Cada vez que se va a ejecutar una linea
function _steptrap
{
_lineaactual=$1
# Si estamos trazando imprime la linea ejecutada
(( $_trace )) &&\
_msg "$PS4:$_lineaactual:${_lineas[_lineaactual-1]}"
# Si hemos llegado al final sale
if (( _lineaactual==${#_lineas[@]} )) ;then
exit 0
fi
# Decrementa _steps (solo si es mayor o igual a 0)
if (( $_steps >= 0 )); then
let _steps=$_steps-1
fi
if _tienebp $_lineaactual; then
_msg "Detenido en breakpoint en linea $_lineaactual"
_cmdprompt
elif [ -n "$_condbc" ] && eval $_condbc; then
_msg "Se cumplio la condicion \'$_condbc\' en la"\
Pág 160

